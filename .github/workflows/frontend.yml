# Universal OIDC Frontend Template
# Requirements:
# 1. Managed Identity with "Storage Blob Data Contributor"
# 2. Federated Trust set to this repo
# 3. Secrets: AZURE_CLIENT_ID, AZURE_TENANT_ID, AZURE_SUBSCRIPTION_ID
# 4. Variables: STORAGE_ACCOUNT_NAME

name: PRO_TEMPLATE_FRONTEND_DEPLOY

on:
  push:
    branches: [main] # Only runs when you push to main
# IMPORTANT: Limit permissions for security
permissions:
  id-token: write # CRITICAL: This allows the OIDC handshake
  contents: read # Allows the action to read your code

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. Pull the code from your repo
      - name: "Checkout GitHub Action"
        uses: actions/checkout@v4
      # 2. Log into Azure using OIDC (No Password)
      - name: "Az CLI login"
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      # 3. Upload files to the $web container in Storage
      - name: "Sync Files to Azure"
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az storage blob upload-batch \
              --account-name crcmainxrg1765444963\
              --auth-mode login \
              -d '$web' \
              -s . \
              --overwrite
